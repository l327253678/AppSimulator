{% extends 'base_backend_frameless.html' %}
{% load static %}

{% block header_tail %}
  <link rel="stylesheet" href="{% static 'AppSimulator/css/tasks.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables/dataTables.bootstrap.css' %}">
{% endblock header_tail %}

{% block section_content %}
  <div id="tasks" style="height:800px"></div>
  <div id="main">
    <div id="children" style="height:400px"></div>
  </div>
{% endblock section_content %}

{% block jquery_js %}

{% endblock jquery_js %}

{% block body_tail %}
  <!-- page script -->
  <script type="text/javascript" src="{% static 'plugins/echarts/echarts.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'dist/js/demo.js' %}"></script>
  <script type="text/javascript" src="{% static 'backend/js/theme/dark.js' %}"></script>
  <script type="text/javascript" src="{% static 'backend/js/theme/infographic.js' %}"></script>
  <script type="text/javascript" src="{% static 'backend/js/theme/macarons.js' %}"></script>
  <script type="text/javascript" src="{% static 'backend/js/theme/roma.js' %}"></script>
  <script type="text/javascript" src="{% static 'backend/js/theme/shine.js' %}"></script>
  <script type="text/javascript" src="{% static 'backend/js/theme/vintage.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/vue1/vue.js' %}"></script>
  <script type="text/javascript" src="{% static 'AppSimulator/js/csrf.js' %}"></script>
  <script type="text/javascript">
    function draw(tasks, data) {
      let dom = document.getElementById("tasks");
      let myChart = echarts.init(dom, {renderer: 'svg'});
      let app = {};
      app.title = '任务启动次数分布';

      let hours = ['0am', '1am', '2am', '3am', '4am', '5am', '6am', '7am', '8am', '9am', '10am', '11am', '12am',
        '1pm', '2pm', '3pm', '4pm', '5pm', '6pm', '7pm', '8pm', '9pm', '10pm', '11pm'];
      data = data.map(function (item) {
        return [item[1], item[0], item[2] || '-'];
      });

      let option = {
        tooltip: {
          position: 'top'
        },
        animation: false,
        grid: {
          height: '50%',
          y: '10%'
        },
        xAxis: {
          type: 'category',
          data: hours,
          splitArea: {
            show: true
          }
        },
        yAxis: {
          type: 'category',
          data: tasks,
          splitArea: {
            show: true
          },
          triggerEvent: true
        },
        visualMap: {
          min: 0,
          max: 10,
          calculable: true,
          orient: 'horizontal',
          right: 0,
          bottom: '15%'
        },
        series: [{
          name: 'tasks start',
          type: 'heatmap',
          data: data,
          label: {
            normal: {
              {#formatter:'{a}: {b}',#}
              show: true
            }
          },
          itemStyle: {
            emphasis: {
              shadowBlur: 10,
              shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
          }
        }]
      };

      if (option && typeof option === "object") {
        myChart.setOption(option, true);
        myChart.on('click', function (params) {
          console.log(params);
          //  window.open('https://www.baidu.com/s?wd=' + encodeURIComponent(params.name));
          window.location.href = 'http://172.16.253.37:8000/AppSimulator/tasks/';
        });
        myChart.on('mouseover', function (params) {
          console.log(params);
          drawChildren(params.value);
        });
      }
    }

    function getTasksStartHeatmap(tasks) {
      let opt = {
        url: '/AppSimulator/getTasksStartHeatmapAPI/',
        type: 'GET',
        data: {
          taskIdList: JSON.stringify(tasks),
          day: '2018-09-11'
        },
        dataType: "json",
        error: function (xhr, err) {
          console.error("[tasks] getTasksStartHeatmapAPI", err);
        },
        success: function (data, status) {
          console.log(data);
          draw(tasks, data['ret']);
        }
      };
      $.ajax(opt);
    }

    getTasksStartHeatmap([22, 23, 24, 25, 26]);

    function drawChildren(orgTaskId) {
      console.log('drawChildren:', orgTaskId);
      $('#children').remove();
      $('#main').html('<div id="children" style="width:100%;height:300px;"></div>');

      let dom = document.getElementById("children");
      let myChart = echarts.init(dom, {renderer: 'svg'});
      let app = {};
      let option = {
        dataset: {
          source: [
            ['times', 'crawl', 'childTask'],
            [89.3, 58212, 'Matcha Latte'],
            [57.1, 78254, 'Milk Tea'],
            [74.4, 41032, 'Cheese Cocoa'],
            [50.1, 12755, 'Cheese Brownie'],
            [89.7, 20145, 'Matcha Cocoa'],
            [68.1, 79146, 'Tea'],
            [19.6, 91852, 'Orange Juice'],
            [10.6, 101852, 'Lemon Juice'],
            [32.7, 20112, 'Walnut Brownie']
          ]
        },
        grid: {containLabel: true},
        xAxis: {name: 'crawl'},
        yAxis: {type: 'category'},
        visualMap: {
          orient: 'horizontal',
          bottom: 0,
          right: 0,
          min: 10,
          max: 100,
          text: ['long', 'short'],
          dimension: 0,
          inRange: {
            color: ['#D7DA8B', '#E15457']
          }
        },
        series: [
          {
            type: 'bar',
            encode: {
              x: 'crawl',
              y: 'childTask'
            }
          }
        ]
      };
      if (option && typeof option === "object") {
        myChart.setOption(option, true);
      }
    }
  </script>
{% endblock body_tail %}



