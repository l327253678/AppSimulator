{% extends 'base_backend_frameless.html' %}
{% load static %}

{% block header_tail %}
    {#    <meta http-equiv="refresh" content="2">#}
    <link rel="stylesheet" href="{% static 'AppSimulator/css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/datatables/dataTables.bootstrap.css' %}">
{% endblock header_tail %}

{% block section_content %}
    <div id="main" v-cloak>
        <div class="row">
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-aqua">
                    <div class="inner">
                        <p>代理服务器-内存剩余</p>
                        <h3>[[ proxyServerInfo.memory_rate ]]%</h3>
                    </div>
                    <div class="icon">
                        <i class="fa fa-mobile-phone"></i>
                    </div>
                    <a href="/AppSimulator/dashboard/" class="small-box-footer">
                        详情&nbsp;
                        <i class="fa fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-green">
                    <div class="inner">
                        <p>代理服务器-使用CPU</p>
                        <h3>[[ proxyServerInfo.cpu_rate ]]%</h3>
                    </div>
                    <div class="icon">
                        <i class="fa fa-mobile-phone"></i>
                    </div>
                    <a href="/AppSimulator/dashboard/" class="small-box-footer">
                        详情&nbsp;
                        <i class="fa fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-yellow">
                    <div class="inner">
                        <p>代理服务器-硬盘剩余（C盘）</p>
                        <h3>0</h3>
                    </div>
                    <div class="icon">
                        <i class="fa fa-mobile-phone"></i>
                    </div>
                    <a href="/AppSimulator/dashboard/" class="small-box-footer">
                        详情&nbsp;
                        <i class="fa fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-red">
                    <div class="inner">
                        <p>采集总量</p>
                        <h3>0</h3>
                    </div>
                    <div class="icon">
                        <i class="fa fa-mobile-phone"></i>
                    </div>
                    <a href="/AppSimulator/dashboard/" class="small-box-footer">
                        详情&nbsp;
                        <i class="fa fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            {#            <section class="col-md-6 connectedSortable"><!-- 内存使用率 -->#}
            {#                <div class="box box-success">#}
            {#                    <div class="box-header with-border">#}
            {#                        <label class="box-title">内存使用率</label>#}
            {#                        <span class="badge">[[ memorySize ]]</span>#}
            {#                        <div class="box-tools pull-left">#}
            {#                            <span class="label label-success"><i class="fa fa-clock-o"></i>&nbsp;&nbsp;2s 刷新</span>#}
            {#                        </div>#}
            {#                    </div>#}
            {#                    <div class="box-body">#}
            {#                        <div id="memory_monitor" style="width:100%;height:235px;">#}
            {#                            <img src="/static/AppSimulator/images/loading.gif" class="loading">#}
            {#                        </div>#}
            {#                    </div>#}
            {#                </div>#}
            {#            </section>#}
            <section class="col-md-3 connectedSortable"><!-- device1 -->
                <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">device1 <span id="device1" class="badge"></span></h3>
                        <div class="box-tools pull-left">
                            <button v-on:click="resetDevice" class="btn btn-sm btn-info">重启</button>
                            <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="device1" class="device-img">
                            <div class="col-md-6" title="before">
                                <img src="{% static 'AppSimulator/images/capture_before.png' %}" height="240">
                                <label>before</label>
                            </div>
                            <div class="col-md-6" title="current">
                                <img src="{% static 'AppSimulator/images/capture.png' %}" height="240">
                                <label>current</label>
                            </div>
                            <div class="col-md-6">
                                <input type="text" placeholder="latitude" v-model="latitude">
                                <input type="text" placeholder="longitude" v-model="longitude">
                                <button class="btn btn-info" v-on:click="setDeviceGPS">设定</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="col-md-3 connectedSortable"><!-- device2 -->
                <div class="box box-success">
                    <div class="box-header with-border">
                        <h3 class="box-title">device2 <span id="device2" class="badge"></span></h3>
                        <div class="box-tools pull-left">
                            <button class="btn btn-sm btn-success">重启</button>
                            <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="device2" class="device-img">
                        </div>
                    </div>
                </div>
            </section>
            <section class="col-md-3 connectedSortable"><!-- device3 -->
                <div class="box box-warning">
                    <div class="box-header with-border">
                        <h3 class="box-title">device3 <span id="device3" class="badge"></span></h3>
                        <div class="box-tools pull-left">
                            <button class="btn btn-sm btn-warning">重启</button>
                            <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="device3" class="device-img">
                        </div>
                    </div>
                </div>
            </section>
            <section class="col-md-3 connectedSortable"><!-- device4 -->
                <div class="box box-danger">
                    <div class="box-header with-border">
                        <h3 class="box-title">device4 <span id="device4" class="badge"></span></h3>
                        <div class="box-tools pull-left">
                            <button class="btn btn-sm btn-danger">重启</button>
                            <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="device4" class="device-img">
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
{% endblock section_content %}

{% block jquery_js %}

{% endblock jquery_js %}

{% block body_tail %}
    <!-- page script -->
    <script type="text/javascript"
            src="{% static 'plugins/echarts/extension/dataTool.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'plugins/echarts/echarts-all-3.js' %}"></script>
    <script type="text/javascript" src="{% static 'dist/js/demo.js' %}"></script>
    <script type="text/javascript" src="{% static 'backend/js/theme/dark.js' %}"></script>
    <script type="text/javascript" src="{% static 'backend/js/theme/infographic.js' %}"></script>
    <script type="text/javascript" src="{% static 'backend/js/theme/macarons.js' %}"></script>
    <script type="text/javascript" src="{% static 'backend/js/theme/roma.js' %}"></script>
    <script type="text/javascript" src="{% static 'backend/js/theme/shine.js' %}"></script>
    <script type="text/javascript" src="{% static 'backend/js/theme/vintage.js' %}"></script>
    <script type="text/javascript" src="{% static 'AppSimulator/js/csrf.js' %}"></script>
    <script type="text/javascript" src="{% static 'AppSimulator/js/dashboard.js' %}"></script>
    <script src="{% static 'plugins/vue1/vue.js' %}"></script>
    <script type="text/javascript">
        {#const HOST = "http://172.16.55.155:8000";#}
        {#const HOST = "http://192.168.31.227:8000";#}

        setInterval(function getProxyServerInfoAPI() {
            if (mainVue.deviceId === '') {
                alert("请选择设备。");
                return false;
            }
            let opt = {
                url: '/AppSimulator/getProxyServerInfoAPI/',
                type: 'GET',
                data: {
                    deviceId: mainVue.deviceId,
                },
                dataType: "json",
                error: function (xhr, err) {
                    mainVue.msg = "Failure";
                    console.error("[dashboard] setDeviceGPSAPI", err);
                },
                success: function (data, status) {
                    console.log("data", data);
                    mainVue.proxyServerInfo.memory_rate =
                        (data['mem_info']['free'] * 100 / data['mem_info']['total']).toFixed(1);
                    mainVue.proxyServerInfo.cpu_rate = data['cpu_info']['available'];
                    mainVue.msg = "OK";
                }
            };
            $.ajaxSetup({
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'}
            });
            $.ajax(opt);
        }, 10000);

        function setDeviceGPS(obj) {
            if (obj.deviceId === '') {
                alert("请选择设备。");
                return false;
            }
            let opt = {
                url: '/AppSimulator/setDeviceGPSAPI/',
                type: 'POST',
                data: {
                    deviceId: obj.deviceId,
                    latitude: obj.latitude,
                    longitude: obj.longitude
                },
                dataType: "json",
                error: function (xhr, err) {
                    obj.msg = "Failure";
                    console.error("[dashboard] setDeviceGPSAPI", err);
                },
                success: function (data, status) {
                    obj.msg = "OK";
                }
            };
            $.ajax(opt);
        }

        function resetDevice(obj) {
            console.log("resetDevice start.");
            if (obj.deviceId === '') {
                alert("请选择设备。");
                return false;
            }
            let opt = {
                url: '/AppSimulator/resetDeviceAPI/',
                type: 'GET',
                data: {
                    deviceId: obj.deviceId
                },
                dataType: "json",
                error: function (xhr, err) {
                    obj.msg = "Failure";
                    console.error("[dashboard] resetDeviceAPI", err);
                },
                success: function (data, status) {
                    obj.msg = "OK";
                }
            };
            $.ajax(opt);
        }

        //----------------------------------------------------------------------------
        Vue.config.delimiters = ['[[', ']]'];
        //----------------------------------------------------------------------------
        let mainVue = new Vue({
            el: "#main",
            data: {
                proxyServerInfo: {
                    memory_rate: 10,
                    cpu_rate: 10
                },
                deviceId: 'device1',
                district: '海淀区',
                lng_lat: "",
                latitude: 39.6099202570, // 经度
                longitude: 118.1799316404, // 纬度
                current_address: "",
                search_address: '',
                msg: ""
            },
            methods: {
                trace: function () {
                },
                setDeviceGPS: function () {
                    setDeviceGPS(this);
                },
                resetDevice: function () {
                    resetDevice(this);
                },
            },
            ready: function () {
            },
            watch: {},
            computed: {}
        });
    </script>
{% endblock body_tail %}
